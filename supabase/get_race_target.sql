CREATE OR REPLACE FUNCTION get_race_target(
    p_rating1 numeric,
    p_rating2 numeric,
    p_game_type text -- '8ball' or '9ball'
)
RETURNS jsonb
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
    v_r1 int := COALESCE(p_rating1, 500);
    v_r2 int := COALESCE(p_rating2, 500);
    v_idx1 int;
    v_idx2 int;
    v_race int[];
    v_matrix int[][][]; -- 3D array: [row][col][p1, p2]
BEGIN
    -- 1. Helper Index Logic
    -- 0: <= 275
    -- 1: <= 349
    -- 2: <= 399
    -- 3: <= 449
    -- 4: <= 499
    -- 5: <= 549
    -- 6: <= 599
    -- 7: <= 700
    -- 8: > 700
    
    SELECT CASE 
        WHEN v_r1 <= 275 THEN 0
        WHEN v_r1 <= 349 THEN 1
        WHEN v_r1 <= 399 THEN 2
        WHEN v_r1 <= 449 THEN 3
        WHEN v_r1 <= 499 THEN 4
        WHEN v_r1 <= 549 THEN 5
        WHEN v_r1 <= 599 THEN 6
        WHEN v_r1 <= 700 THEN 7
        ELSE 8 
    END INTO v_idx1;

    SELECT CASE 
        WHEN v_r2 <= 275 THEN 0
        WHEN v_r2 <= 349 THEN 1
        WHEN v_r2 <= 399 THEN 2
        WHEN v_r2 <= 449 THEN 3
        WHEN v_r2 <= 499 THEN 4
        WHEN v_r2 <= 549 THEN 5
        WHEN v_r2 <= 599 THEN 6
        WHEN v_r2 <= 700 THEN 7
        ELSE 8 
    END INTO v_idx2;

    -- 2. Define Matrix
    IF p_game_type = '9ball' THEN
        v_matrix := ARRAY[
            -- Row 0 (200-275)
            [[2, 2], [2, 3], [2, 3], [2, 4], [2, 4], [2, 5], [2, 5], [2, 7], [2, 7]],
            -- Row 1 (276-349)
            [[3, 2], [3, 3], [3, 4], [3, 4], [3, 5], [3, 5], [3, 6], [2, 7], [2, 7]],
            -- Row 2 (350-399)
            [[3, 2], [3, 3], [3, 3], [3, 4], [3, 5], [3, 5], [3, 6], [2, 7], [2, 7]],
            -- Row 3 (400-449)
            [[4, 2], [4, 3], [4, 3], [4, 4], [4, 5], [4, 5], [4, 6], [4, 7], [3, 7]],
            -- Row 4 (450-499)
            [[4, 2], [4, 3], [4, 3], [4, 4], [5, 5], [4, 5], [4, 6], [4, 7], [3, 7]], 
            -- Row 5 (500-549)
            [[5, 2], [5, 3], [5, 3], [5, 4], [5, 4], [5, 5], [5, 6], [4, 7], [4, 7]],
            -- Row 6 (550-599)
            [[5, 2], [5, 3], [5, 3], [5, 4], [5, 4], [5, 5], [5, 6], [5, 7], [4, 7]],
            -- Row 7 (600-700)
            [[6, 2], [6, 2], [6, 3], [6, 4], [6, 4], [6, 5], [6, 6], [6, 7], [6, 7]],
            -- Row 8 (701+)
            [[7, 2], [7, 2], [7, 3], [7, 3], [7, 4], [7, 4], [7, 5], [7, 6], [8, 8]]
        ];
    ELSE
        -- 8-Ball Matrix
        v_matrix := ARRAY[
            -- Row 0 (200-275)
            [[2, 2], [2, 3], [2, 4], [2, 5], [2, 5], [2, 5], [2, 6], [2, 6], [2, 6]],
            -- Row 1 (276-349)
            [[3, 2], [3, 3], [3, 3], [3, 4], [3, 4], [3, 5], [2, 5], [2, 5], [2, 6]],
            -- Row 2 (350-399)
            [[4, 2], [3, 3], [3, 3], [3, 4], [3, 4], [3, 5], [3, 5], [2, 5], [2, 6]],
            -- Row 3 (400-449)
            [[4, 2], [4, 3], [4, 3], [4, 4], [4, 4], [3, 5], [3, 5], [3, 5], [2, 6]],
            -- Row 4 (450-499)
            [[5, 2], [4, 3], [4, 3], [4, 4], [4, 4], [4, 5], [3, 5], [3, 5], [3, 6]],
            -- Row 5 (500-549)
            [[5, 2], [5, 3], [5, 3], [5, 3], [5, 4], [4, 4], [4, 5], [4, 5], [3, 6]],
            -- Row 6 (550-599)
            [[6, 2], [6, 2], [5, 3], [5, 3], [5, 3], [5, 4], [4, 4], [4, 5], [4, 6]],
            -- Row 7 (600-700)
            [[6, 2], [6, 2], [5, 2], [5, 3], [5, 3], [5, 4], [5, 4], [5, 5], [5, 6]],
            -- Row 8 (701+)
            [[6, 2], [6, 2], [6, 2], [6, 2], [6, 3], [6, 3], [6, 4], [6, 5], [6, 6]]
        ];
    END IF;

    -- 3. Lookup
    -- Access 1-based index for PL/pgSQL arrays
    -- v_matrix is 3D: [row][col][p1/p2]
    
    RETURN jsonb_build_object(
        'p1', v_matrix[v_idx1 + 1][v_idx2 + 1][1],
        'p2', v_matrix[v_idx1 + 1][v_idx2 + 1][2]
    );
END;
$$;
